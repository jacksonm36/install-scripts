#!/usr/bin/env bash
set -euo pipefail

# OpenArchiver installer (idempotent, multi-CPU, multi-OS)
# - Debian/Ubuntu (apt) and RHEL/Fedora (dnf/yum)
# - Valkey only (no Redis fallback)
# - PostgreSQL 17, Node 22 + pnpm, MeiliSearch v1.29.0 (arch-aware), Apache Tika 3.2.3 (tika-app)
# - Auto-generates passwords/secrets each run
# - Health checks: Meili + Tika only (app check removed)

msg_info() { echo -e "\e[34m[INFO]\e[0m $*"; }
msg_ok()   { echo -e "\e[32m[ OK ]\e[0m $*"; }
msg_err()  { echo -e "\e[31m[ERR]\e[0m $*"; }

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    msg_err "This installer must be run as root."; exit 1
  fi
}

gen_alnum() {
  local len="${1:-18}"
  local out=""
  while [[ "${#out}" -lt "$len" ]]; do
    if command -v openssl >/dev/null 2>&1; then
      out+="$(openssl rand -base64 48 | tr -dc 'A-Za-z0-9' | head -c "$len" || true)"
    else
      out+="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c "$len" || true)"
    fi
  done
  printf '%s' "${out:0:len}"
}

detect_os() {
  if [[ -r /etc/os-release ]]; then
    . /etc/os-release
    ID_LIKE="${ID_LIKE:-}"
  else
    msg_err "/etc/os-release not found; unsupported OS"; exit 1
  fi
  case "$ID" in
    debian|ubuntu) PM=apt-get; OS_FAMILY=debian ;;
    fedora) PM=dnf; OS_FAMILY=fedora ;;
    rhel|centos|almalinux|rocky|ol|oraclelinux) PM=dnf; OS_FAMILY=rhel ;;
    *)
      if   [[ "$ID_LIKE" =~ (debian|ubuntu) ]]; then PM=apt-get; OS_FAMILY=debian
      elif [[ "$ID_LIKE" =~ (rhel|fedora|centos) ]]; then PM=dnf; OS_FAMILY=rhel
      else msg_err "Unsupported OS: $ID"; exit 1; fi
      ;;
  esac
}

install_base_packages() {
  case "$OS_FAMILY" in
    debian)
      $PM update -y
      $PM install -y curl ca-certificates sudo gnupg lsb-release \
        build-essential pkg-config libssl-dev jq tar git coreutils findutils \
        unzip iproute2 util-linux
      ;;
    fedora|rhel)
      $PM -y install curl ca-certificates sudo gnupg2 redhat-lsb-core \
        @development-tools pkgconfig openssl-devel jq tar git coreutils findutils \
        unzip iproute util-linux
      ;;
  esac
}

install_valkey() {
  case "$OS_FAMILY" in
    debian) $PM install -y valkey ;;
    fedora|rhel) $PM -y install valkey ;;
  esac
}

install_java_for_tika() {
  case "$OS_FAMILY" in
    debian)
      $PM install -y openjdk-17-jre-headless || true
      $PM install -y openjdk-21-jre-headless || true
      $PM install -y default-jre-headless || true
      command -v java >/dev/null 2>&1 || { msg_err "Java runtime install failed"; exit 1; }
      ;;
    fedora|rhel)
      $PM -y install java-17-openjdk || true
      $PM -y install java-21-openjdk || true
      $PM -y install java-latest-openjdk || true
      command -v java >/dev/null 2>&1 || { msg_err "Java runtime install failed"; exit 1; }
      ;;
  esac
}

install_node() {
  NODE_VERSION="22"
  if ! command -v node >/dev/null 2>&1; then
    if [[ "$OS_FAMILY" == "debian" ]]; then
      curl -fsSL "https://deb.nodesource.com/setup_${NODE_VERSION}.x" | bash -
      $PM install -y nodejs
    else
      curl -fsSL "https://rpm.nodesource.com/setup_${NODE_VERSION}.x" | bash -
      $PM -y install nodejs
    fi
  fi
  corepack enable
  corepack prepare pnpm@latest --activate
}

install_postgres() {
  PG_VERSION="17"
  if ! command -v psql >/dev/null 2>&1; then
    case "$OS_FAMILY" in
      debian)
        echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" >/etc/apt/sources.list.d/pgdg.list
        curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
        $PM update -y
        $PM install -y "postgresql-${PG_VERSION}" "postgresql-client-${PG_VERSION}"
        ;;
      fedora|rhel)
        rpm -qi pgdg-redhat-repo >/dev/null 2>&1 || \
          dnf -y install "https://download.postgresql.org/pub/repos/yum/reporpms/EL-$(rpm -E '%{rhel}')-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
        $PM -y install "postgresql${PG_VERSION//./}" "postgresql${PG_VERSION//./}-server"
        ;;
    esac
  fi
}

start_postgres() {
  msg_info "Starting PostgreSQL service"
  if ! command -v systemctl >/dev/null 2>&1; then
    msg_err "systemctl not found; cannot manage PostgreSQL service automatically"; exit 1
  fi

  # RHEL/Fedora: initialize the data directory if needed.
  if [[ "$OS_FAMILY" != "debian" ]]; then
    if [[ -x "/usr/pgsql-${PG_VERSION}/bin/postgresql-${PG_VERSION}-setup" ]]; then
      "/usr/pgsql-${PG_VERSION}/bin/postgresql-${PG_VERSION}-setup" initdb || true
    elif command -v "postgresql-${PG_VERSION}-setup" >/dev/null 2>&1; then
      "postgresql-${PG_VERSION}-setup" initdb || true
    elif command -v postgresql-setup >/dev/null 2>&1; then
      postgresql-setup --initdb || true
    fi
  fi

  # Try common unit names across distros.
  systemctl enable -q --now "postgresql@${PG_VERSION}-main" 2>/dev/null || true
  systemctl enable -q --now "postgresql-${PG_VERSION}" 2>/dev/null || true
  systemctl enable -q --now postgresql 2>/dev/null || true

  # Wait until PostgreSQL is accepting connections.
  if command -v pg_isready >/dev/null 2>&1; then
    local i
    for i in {1..30}; do
      if pg_isready -q; then
        msg_ok "PostgreSQL is ready"
        return 0
      fi
      sleep 1
    done
    msg_err "PostgreSQL did not become ready in time"; exit 1
  fi
}

install_meili() {
  local arch="$(uname -m)"
  local asset=""
  case "$arch" in
    x86_64|amd64) asset="meilisearch-linux-amd64" ;;
    aarch64|arm64) asset="meilisearch-linux-aarch64" ;;
    *) msg_err "Unsupported architecture: $arch"; exit 1 ;;
  esac

  if [[ ! -x /usr/bin/meilisearch ]]; then
    msg_info "Fetching MeiliSearch v1.29.0 for $arch"
    curl -fsSL "https://github.com/meilisearch/meilisearch/releases/download/v1.29.0/${asset}" -o /usr/bin/meilisearch
    chmod +x /usr/bin/meilisearch
    msg_ok "MeiliSearch fetched"
  else
    msg_info "MeiliSearch already installed; skipping download"
  fi

  mkdir -p /var/lib/meilisearch/data /var/lib/meilisearch/dumps /var/lib/meilisearch/snapshots

  local unit_path="/etc/systemd/system/meilisearch.service"
  local cfg_path="/etc/meilisearch.toml"
  curl -fsSL https://raw.githubusercontent.com/meilisearch/meilisearch/v1.29.0/config.toml -o "$cfg_path"

  local http_addr='0.0.0.0:7700'
  sed -i \
    -e 's|^env =.*|env = "production"|' \
    -e "s|^# master_key =.*|master_key = \"${MEILI_MASTER_KEY}\"|" \
    -e 's|^db_path =.*|db_path = "/var/lib/meilisearch/data"|' \
    -e 's|^dump_dir =.*|dump_dir = "/var/lib/meilisearch/dumps"|' \
    -e 's|^snapshot_dir =.*|snapshot_dir = "/var/lib/meilisearch/snapshots"|' \
    -e 's|^# no_analytics = true|no_analytics = true|' \
    -e "s|^http_addr =.*|http_addr = \"${http_addr}\"|" \
    "$cfg_path"

  local new_unit
  new_unit=$(cat <<EOF
[Unit]
Description=Meilisearch
After=network.target

[Service]
ExecStart=/usr/bin/meilisearch --config-file-path ${cfg_path}
Restart=always

[Install]
WantedBy=multi-user.target
EOF
)
  local unit_changed=0
  if [[ ! -f "$unit_path" ]] || [[ "$(cat "$unit_path")" != "$new_unit" ]]; then
    echo "$new_unit" > "$unit_path"
    unit_changed=1
  fi
  if [[ $unit_changed -eq 1 ]]; then
    systemctl daemon-reload
    systemctl enable -q --now meilisearch
  else
    systemctl enable -q meilisearch
    systemctl restart meilisearch
  fi
}

install_tika() {
  local TIKA_DIR="/opt/tika"
  mkdir -p "$TIKA_DIR"
  local jar="${TIKA_DIR}/tika-app.jar"
  local url="https://dlcdn.apache.org/tika/3.2.3/tika-app-3.2.3.jar"

  if [[ -f "$jar" ]]; then
    msg_info "Tika jar already present; skipping download"
  else
    msg_info "Downloading Tika 3.2.3"
    curl -fsSL "$url" -o "$jar"
    msg_ok "Tika downloaded"
  fi

  local unit_path="/etc/systemd/system/tika.service"
  local new_unit
  new_unit=$(cat <<EOF
[Unit]
Description=Apache Tika Server
After=network.target

[Service]
Type=simple
WorkingDirectory=${TIKA_DIR}
ExecStart=/usr/bin/java -jar ${jar} --host 0.0.0.0 --port 9998
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF
)
  local unit_changed=0
  if [[ ! -f "$unit_path" ]] || [[ "$(cat "$unit_path")" != "$new_unit" ]]; then
    echo "$new_unit" > "$unit_path"
    unit_changed=1
  fi
  if [[ $unit_changed -eq 1 ]]; then
    systemctl daemon-reload
    systemctl enable -q --now tika
  else
    systemctl enable -q tika
    systemctl restart tika
  fi
}

health_checks() {
  local ok=0
  curl -sf http://127.0.0.1:7700/health >/dev/null && msg_ok "MeiliSearch health: OK" || { msg_err "MeiliSearch health: FAILED (http://127.0.0.1:7700/health)"; ok=1; }
  curl -sf http://127.0.0.1:9998/version >/dev/null && msg_ok "Tika health: OK" || { msg_err "Tika health: FAILED (http://127.0.0.1:9998/version)"; ok=1; }
  return $ok
}

IP_ADDR="$(hostname -I | awk '{print $1}')"
if [[ -z "$IP_ADDR" ]]; then msg_err "Could not determine IP address"; exit 1; fi

# Generate secrets per run (before Meili install so we can inject master key)
POSTGRES_DB="openarchiver_db"
POSTGRES_USER="openarchiver"
POSTGRES_PASSWORD="$(gen_alnum 18)"
MEILI_MASTER_KEY="$(openssl rand -base64 18)"
JWT_SECRET="$(openssl rand -hex 32)"
ENCRYPTION_KEY="$(openssl rand -hex 32)"

require_root
detect_os
install_base_packages
install_valkey
install_java_for_tika
install_node
install_postgres
start_postgres
install_meili
install_tika

msg_info "Setting up PostgreSQL"
sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='${POSTGRES_USER}'" | grep -q 1 || \
  sudo -u postgres psql -c "CREATE ROLE ${POSTGRES_USER} WITH LOGIN PASSWORD '${POSTGRES_PASSWORD}';"
sudo -u postgres psql -c "ALTER ROLE ${POSTGRES_USER} WITH LOGIN PASSWORD '${POSTGRES_PASSWORD}';"
sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='${POSTGRES_DB}'" | grep -q 1 || \
  sudo -u postgres psql -c "CREATE DATABASE ${POSTGRES_DB} WITH OWNER ${POSTGRES_USER} ENCODING 'UTF8' TEMPLATE template0;"
sudo -u postgres psql -c "ALTER DATABASE ${POSTGRES_DB} OWNER TO ${POSTGRES_USER};"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE ${POSTGRES_DB} TO ${POSTGRES_USER};"
sudo -u postgres psql -d "${POSTGRES_DB}" -c "GRANT ALL PRIVILEGES ON SCHEMA public TO ${POSTGRES_USER};"
sudo -u postgres psql -c "ALTER ROLE ${POSTGRES_USER} SET client_encoding TO 'utf8';"
sudo -u postgres psql -c "ALTER ROLE ${POSTGRES_USER} SET default_transaction_isolation TO 'read committed';"
sudo -u postgres psql -c "ALTER ROLE ${POSTGRES_USER} SET timezone TO 'UTC';"
{
  echo "Open Archiver DB Credentials"
  echo "Database Name: ${POSTGRES_DB}"
  echo "Database User: ${POSTGRES_USER}"
  echo "Database Password: ${POSTGRES_PASSWORD}"
} > ~/openarchiver.creds
chmod 600 ~/openarchiver.creds
msg_ok "PostgreSQL configured"

# Ensure Meili config matches generated master key
sed -i \
  -e "s|^master_key =.*|master_key = \"${MEILI_MASTER_KEY}\"|" \
  -e 's|^http_addr =.*|http_addr = "0.0.0.0:7700"|' \
  /etc/meilisearch.toml
systemctl restart meilisearch

# Fetch OpenArchiver if absent
if [[ ! -d /opt/openarchiver ]]; then
  msg_info "Fetching OpenArchiver"
  tmpdir="$(mktemp -d)"
  pushd "$tmpdir" >/dev/null
  tarball="$(curl -fsSL "https://api.github.com/repos/LogicLabs-OU/OpenArchiver/releases/latest" | jq -r '.tarball_url')"
  curl -fsSL "$tarball" -o openarchiver.tar.gz
  mkdir -p /opt/openarchiver
  tar -xzf openarchiver.tar.gz --strip-components=1 -C /opt/openarchiver
  popd >/dev/null
  rm -rf "$tmpdir"
  msg_ok "OpenArchiver fetched"
fi

msg_info "Writing .env (auto-generated secrets)"
cat > /opt/openarchiver/.env <<EOF
# --- Application Settings ---
NODE_ENV=production
PORT_BACKEND=4000
PORT_FRONTEND=3000
APP_URL=http://${IP_ADDR}:3000
ORIGIN=http://${IP_ADDR}:3000
SYNC_FREQUENCY='* * * * *'
ALL_INCLUSIVE_ARCHIVE=false

# Backend binding and public URLs
BACKEND_HOST=0.0.0.0
BACKEND_PORT=4000
PORT=3000
HOST=0.0.0.0
PUBLIC_BACKEND_URL=http://127.0.0.1:4000
VITE_PUBLIC_BACKEND_URL=http://127.0.0.1:4000
API_URL=http://127.0.0.1:4000

# PostgreSQL
POSTGRES_DB=${POSTGRES_DB}
POSTGRES_USER=${POSTGRES_USER}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/${POSTGRES_DB}"

# Meilisearch
MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
MEILI_HOST=http://127.0.0.1:7700
MEILI_INDEXING_BATCH=500

# Valkey
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_TLS_ENABLED=false

# Storage
STORAGE_TYPE=local
BODY_SIZE_LIMIT=100M
STORAGE_LOCAL_ROOT_PATH=/opt/openarchiver-data

# S3 (unused if STORAGE_TYPE=local)
STORAGE_S3_ENDPOINT=
STORAGE_S3_BUCKET=
STORAGE_S3_ACCESS_KEY_ID=
STORAGE_S3_SECRET_ACCESS_KEY=
STORAGE_S3_REGION=
STORAGE_S3_FORCE_PATH_STYLE=false

# Storage Encryption (optional)
STORAGE_ENCRYPTION_KEY=

# Security & Authentication
ENABLE_DELETION=false
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=100

# JWT
JWT_SECRET=${JWT_SECRET}
JWT_EXPIRES_IN="7d"

# Master Encryption Key
ENCRYPTION_KEY=${ENCRYPTION_KEY}

# Apache Tika
TIKA_URL=http://127.0.0.1:9998
EOF

mkdir -p /opt/openarchiver-data
cd /opt/openarchiver

if [[ ! -d node_modules ]]; then
  pnpm install --shamefully-hoist --frozen-lockfile --prod=false
else
  pnpm install --shamefully-hoist --frozen-lockfile --prod=false --prefer-offline
fi

pnpm run build:oss
pnpm db:migrate
msg_ok "Open Archiver setup complete"

msg_info "Creating service"
OA_UNIT_PATH="/etc/systemd/system/openarchiver.service"
OA_UNIT_CONTENT=$(cat <<EOF
[Unit]
Description=Open Archiver Service
After=network-online.target

[Service]
Type=simple
User=root
EnvironmentFile=/opt/openarchiver/.env
WorkingDirectory=/opt/openarchiver
ExecStart=/usr/bin/pnpm docker-start:oss
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF
)
OA_UNIT_CHANGED=0
if [[ ! -f "$OA_UNIT_PATH" ]] || [[ "$(cat "$OA_UNIT_PATH")" != "$OA_UNIT_CONTENT" ]]; then
  echo "$OA_UNIT_CONTENT" > "$OA_UNIT_PATH"
  OA_UNIT_CHANGED=1
fi
if [[ $OA_UNIT_CHANGED -eq 1 ]]; then
  systemctl daemon-reload
  systemctl enable -q --now openarchiver
else
  systemctl enable -q openarchiver
  systemctl restart openarchiver
fi
msg_ok "Service created and started"

msg_info "Running health checks (Meili, Tika only)"
if health_checks; then
  msg_ok "All health checks passed."
else
  msg_err "One or more health checks failed. See messages above."
  exit 1
fi

msg_ok "Installation complete. Visit: http://${IP_ADDR}:3000"
