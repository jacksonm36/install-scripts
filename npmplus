version: "3.9"

services:
  npmplus:
    container_name: npmplus
    image: docker.io/zoeyvid/npmplus:latest
    restart: always
    network_mode: host
    ipc: host
    volumes:
      - "/opt/npmplus:/data"
      - "shm-volume:/dev/shm/check-point"
    environment:
      - "TZ=Etc/UTC"
      - "ACME_EMAIL=picikutyu@gmail.com"
      - "NGINX_LOAD_OPENAPPSEC_ATTACHMENT_MODULE=true"
      - "INITIAL_ADMIN_EMAIL=admin@example.com"
      - "INITIAL_ADMIN_PASSWORD=ChangeMeNow!"
      - "NGINX_QUIC_BPF=true"
      - "DISABLE_HTTP=true"
      - "LOGROTATE=true"
      - "LOGROTATIONS=7"
      - "GOA=true"
      - "GOA_PORT=91"
      - "GOACLA=--agent-list --real-os --double-decode --anonymize-ip --anonymize-level=2 --keep-last=7 --with-output-resolver --no-query-string"
    cap_add:
      - BPF
      - PERFMON
      - NET_ADMIN

  openappsec-agent:
    container_name: openappsec-agent
    image: ghcr.io/openappsec/agent:latest
    restart: always
    ipc: host
    volumes:
      - "shm-volume:/dev/shm/check-point"
      - "/opt/openappsec/conf:/etc/cp/conf"
      - "/opt/openappsec/data:/etc/cp/data"
      - "/opt/openappsec/logs:/var/log/nano_agent"
      - "/opt/openappsec/localconf:/ext/appsec"
      - "/opt/openappsec/open-appsec-advanced-model/open-appsec-advanced-model.tgz:/advanced-model/open-appsec-advanced-model.tgz:rw"
    environment:
      - "TZ=Etc/UTC"
      - "autoPolicyLoad=true"
      - "registered_server=NPMplus"
      - "user_email=picikutyu@gmail.com"
      - "AGENT_TOKEN=cp-4e70be3f-42f7-4e55-b4af-9945023476253904fe13-c872-4f3b-929e-6c7930bb6374"
    command: /cp-nano-agent

  # NPMplus -> Anubis -> your upstream
  anubis:
    container_name: anubis
    image: ghcr.io/techarohq/anubis:latest
    restart: always
    network_mode: host
    environment:
      # Host-only bindings (not publicly exposed)
      - "BIND=127.0.0.1:8300"
      - "METRICS_BIND=127.0.0.1:10000"
      # NPMplus auth_request mode: TARGET must be exactly one space
      - "TARGET= "
      - "TARGET_INSECURE_SKIP_VERIFY=false"
      # Cookie/domain behavior
      - "COOKIE_DYNAMIC_DOMAIN=true"
      - "COOKIE_EXPIRATION_TIME=168h"
      - "COOKIE_SECURE=true"
      # Challenge settings
      - "DIFFICULTY=4"
      - "SERVE_ROBOTS_TXT=true"
      # Use policy file to enable Redis store and rules
      - "POLICY_FNAME=/data/cfg/botPolicy.yaml"
      # Recommended: same key across Anubis instances on same base domain
      # - "ED25519_PRIVATE_KEY_HEX=PUT_64_HEX_CHARS_HERE"
    volumes:
      - "/opt/anubis/policy.yaml:/data/cfg/botPolicy.yaml:ro"

  dozzle:
    container_name: dozzle
    image: amir20/dozzle:latest
    restart: unless-stopped
    ports:
      - "9999:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    environment:
      - "DOZZLE_NO_ANALYTICS=1"
      - "TZ=Etc/UTC"

  crowdsec:
    container_name: crowdsec
    image: docker.io/crowdsecurity/crowdsec:latest
    restart: always
    network_mode: bridge
    ports:
      - "127.0.0.1:7422:7422" # appsec listener (kept loopback)
      - "127.0.0.1:8080:8080" # local API (kept loopback)
    environment:
      - "TZ=Etc/UTC"
      - "COLLECTIONS=ZoeyVid/npmplus"
    volumes:
      - "/opt/crowdsec/conf:/etc/crowdsec"
      - "/opt/crowdsec/data:/var/lib/crowdsec/data"
      - "/opt/npmplus/nginx:/opt/npmplus/nginx:ro"
      - "/opt/openappsec/logs:/opt/openappsec/logs:ro"

volumes:
  shm-volume:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
